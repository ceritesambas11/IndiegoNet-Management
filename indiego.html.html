
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indiego.Net Managen</title>
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1a1a1a;
        }
        .text-red-600 {
            color: #E53935;
        }
        .bg-red-600 {
            background-color: #E53935;
        }
        .hover\:bg-red-700:hover {
            background-color: #D32F2F;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div id="app-container" class="w-full max-w-2xl bg-white p-6 md:p-10 rounded-xl shadow-2xl transition-all duration-300">
        
        <!-- Modal -->
        <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity duration-300"></div>
        <div id="custom-modal" class="fixed inset-0 flex items-center justify-center z-50 p-4 hidden">
            <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-xl transform transition-transform duration-300">
                <h3 id="modal-title" class="text-xl font-semibold mb-4 text-gray-800"></h3>
                <p id="modal-message" class="text-gray-600 mb-6"></p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition">Batal</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition">Konfirmasi</button>
                </div>
            </div>
        </div>

        <!-- Login Section -->
        <div id="login-section" class="flex flex-col items-center p-8">
            <img src="favicon.png" alt="Indiego.Net Logo" class="w-24 h-24 mb-4">
            <h1 class="text-3xl font-bold mb-2 text-center text-gray-800">Indiego.Net Management</h1>
            <p class="text-gray-500 mb-8 text-center">Masuk untuk melanjutkan</p>
            <div class="w-full max-w-sm space-y-4">
                <input id="username-input" type="text" placeholder="Username" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition">
                <input id="password-input" type="password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition">
                <button id="login-btn" class="w-full bg-red-600 text-white font-semibold py-3 rounded-lg hover:bg-red-700 transition">Login</button>
                <button id="register-btn" class="w-full bg-gray-200 text-gray-800 font-semibold py-3 rounded-lg hover:bg-gray-300 transition">Registrasi</button>
            </div>
        </div>

        <!-- Main App Section -->
        <div id="main-app" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
                <div class="flex items-center space-x-2">
                    <span id="welcome-message" class="text-gray-600 font-medium"></span>
                    <button id="logout-btn" class="bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition">Logout</button>
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <button id="nav-pelanggan" class="nav-btn bg-red-600 text-white py-3 px-4 rounded-lg shadow-md hover:bg-red-700 transition transform hover:scale-105">Data Pelanggan</button>
                <button id="nav-voucher" class="nav-btn bg-red-600 text-white py-3 px-4 rounded-lg shadow-md hover:bg-red-700 transition transform hover:scale-105">Pengiriman Voucher</button>
                <button id="nav-penagihan" class="nav-btn bg-red-600 text-white py-3 px-4 rounded-lg shadow-md hover:bg-red-700 transition transform hover:scale-105">Penagihan</button>
                <button id="nav-laporan" class="nav-btn bg-red-600 text-white py-3 px-4 rounded-lg shadow-md hover:bg-red-700 transition transform hover:scale-105">Laporan</button>
            </div>

            <!-- Content Sections -->
            <div id="content-pelanggan" class="content-section hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Data Pelanggan</h2>
                <div class="flex space-x-4 mb-4">
                    <button id="btn-tipe-bulanan" class="flex-1 py-2 px-4 rounded-lg font-medium border-2 border-red-600 bg-red-600 text-white transition">Bulanan</button>
                    <button id="btn-tipe-toko" class="flex-1 py-2 px-4 rounded-lg font-medium border-2 border-gray-300 text-gray-700 hover:bg-gray-100 transition">Toko</button>
                </div>
                
                <form id="form-pelanggan" class="space-y-4 p-6 bg-gray-50 rounded-lg shadow-inner">
                    <div class="flex flex-col">
                        <label for="nama-pelanggan" class="text-sm font-medium text-gray-700">Nama</label>
                        <input id="nama-pelanggan" type="text" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div class="flex flex-col">
                        <label for="alamat-pelanggan" class="text-sm font-medium text-gray-700">Alamat</label>
                        <input id="alamat-pelanggan" type="text" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div class="flex flex-col">
                        <label for="hp-pelanggan" class="text-sm font-medium text-gray-700">Nomor HP</label>
                        <input id="hp-pelanggan" type="tel" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div class="flex flex-col">
                        <label for="foto-rumah" class="text-sm font-medium text-gray-700">Foto Rumah</label>
                        <input id="foto-rumah" type="file" accept="image/*" class="p-3 border rounded-lg mt-1">
                    </div>
                    <div class="flex flex-col">
                        <label for="lokasi-pelanggan" class="text-sm font-medium text-gray-700">Lokasi (Google Maps)</label>
                        <input id="lokasi-pelanggan" type="url" placeholder="URL Google Maps" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div id="info-tagihan-bulanan" class="flex flex-col">
                        <label for="tagihan-bulanan" class="text-sm font-medium text-gray-700">Total Tagihan Bulanan</label>
                        <input id="tagihan-bulanan" type="number" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div id="info-tagihan-toko" class="flex flex-col hidden">
                        <label for="persentase-toko" class="text-sm font-medium text-gray-700">Persentase Toko (%)</label>
                        <input id="persentase-toko" type="number" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <button type="submit" class="w-full bg-red-600 text-white font-semibold py-3 rounded-lg hover:bg-red-700 transition">Simpan Pelanggan</button>
                </form>
            </div>

            <div id="content-voucher" class="content-section hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Input Pengiriman Voucher</h2>
                <div class="space-y-4 p-6 bg-gray-50 rounded-lg shadow-inner">
                    <div class="flex flex-col">
                        <label for="select-toko" class="text-sm font-medium text-gray-700">Pilih Toko</label>
                        <select id="select-toko" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500"></select>
                    </div>
                    <div class="flex flex-col">
                        <label for="input-vocer-2000" class="text-sm font-medium text-gray-700">Voucher 2000</label>
                        <input id="input-vocer-2000" type="number" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div class="flex flex-col">
                        <label for="input-vocer-5000" class="text-sm font-medium text-gray-700">Voucher 5000</label>
                        <input id="input-vocer-5000" type="number" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <button id="simpan-voucher" class="w-full bg-red-600 text-white font-semibold py-3 rounded-lg hover:bg-red-700 transition">Simpan Pengiriman</button>
                </div>
                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Riwayat Pengiriman</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-lg">
                            <thead>
                                <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">No</th>
                                    <th class="py-3 px-6 text-left">Tanggal</th>
                                    <th class="py-3 px-6 text-left">Toko</th>
                                    <th class="py-3 px-6 text-left">Voucher 2000</th>
                                    <th class="py-3 px-6 text-left">Voucher 5000</th>
                                    <th class="py-3 px-6 text-left">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="riwayat-voucher-body" class="text-gray-600 text-sm font-light">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="content-penagihan" class="content-section hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Penagihan</h2>
                <div class="flex space-x-4 mb-4">
                    <button id="btn-tagihan-bulanan" class="flex-1 py-2 px-4 rounded-lg font-medium border-2 border-red-600 bg-red-600 text-white transition">Bulanan</button>
                    <button id="btn-tagihan-toko" class="flex-1 py-2 px-4 rounded-lg font-medium border-2 border-gray-300 text-gray-700 hover:bg-gray-100 transition">Toko</button>
                </div>
                
                <div id="penagihan-bulanan-section" class="space-y-4 p-6 bg-gray-50 rounded-lg shadow-inner">
                    <div class="flex flex-col">
                        <label for="select-pelanggan-bulanan" class="text-sm font-medium text-gray-700">Pilih Pelanggan</label>
                        <select id="select-pelanggan-bulanan" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500"></select>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-gray-700">Total Tagihan</label>
                        <input id="total-tagihan-bulanan" type="number" readonly class="p-3 border rounded-lg mt-1 bg-gray-200">
                    </div>
                    <button id="bayar-bulanan" class="w-full bg-red-600 text-white font-semibold py-3 rounded-lg hover:bg-red-700 transition">Bayar</button>
                </div>

                <div id="penagihan-toko-section" class="space-y-4 p-6 bg-gray-50 rounded-lg shadow-inner hidden">
                    <div class="flex flex-col">
                        <label for="select-pelanggan-toko" class="text-sm font-medium text-gray-700">Pilih Toko</label>
                        <select id="select-pelanggan-toko" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500"></select>
                    </div>
                    <div class="flex space-x-4">
                        <div class="flex-1 flex flex-col">
                            <label for="tanggal-mulai" class="text-sm font-medium text-gray-700">Tanggal Mulai</label>
                            <input id="tanggal-mulai" type="date" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                        <div class="flex-1 flex flex-col">
                            <label for="tanggal-selesai" class="text-sm font-medium text-gray-700">Tanggal Selesai</label>
                            <input id="tanggal-selesai" type="date" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-gray-700">Total Voucher Terkirim</label>
                        <input id="total-voucher-terkirim" type="number" readonly class="p-3 border rounded-lg mt-1 bg-gray-200">
                    </div>
                    <div class="flex flex-col">
                        <label for="sisa-voucher" class="text-sm font-medium text-gray-700">Sisa Voucher</label>
                        <input id="sisa-voucher" type="number" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-gray-700">Total Tagihan</label>
                        <input id="total-tagihan-toko" type="number" readonly class="p-3 border rounded-lg mt-1 bg-gray-200">
                    </div>
                    <button id="bayar-toko" class="w-full bg-red-600 text-white font-semibold py-3 rounded-lg hover:bg-red-700 transition">Bayar</button>
                </div>
            </div>

            <div id="content-laporan" class="content-section hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Laporan Penjualan</h2>
                <div class="space-y-4 p-6 bg-gray-50 rounded-lg shadow-inner">
                    <div class="flex space-x-4">
                        <div class="flex-1 flex flex-col">
                            <label for="laporan-tanggal-mulai" class="text-sm font-medium text-gray-700">Tanggal Mulai</label>
                            <input id="laporan-tanggal-mulai" type="date" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                        <div class="flex-1 flex flex-col">
                            <label for="laporan-tanggal-selesai" class="text-sm font-medium text-gray-700">Tanggal Selesai</label>
                            <input id="laporan-tanggal-selesai" type="date" class="p-3 border rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                    </div>
                    <button id="tampilkan-laporan" class="w-full bg-red-600 text-white font-semibold py-3 rounded-lg hover:bg-red-700 transition">Tampilkan Laporan</button>
                    
                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Ringkasan Penjualan</h3>
                            <div class="space-x-2">
                                <button id="export-pdf" class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition">Export PDF</button>
                                <button id="export-excel" class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition">Export Excel</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="tabel-laporan" class="min-w-full bg-white rounded-lg shadow-lg">
                                <thead>
                                    <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                        <th class="py-3 px-6 text-left">No</th>
                                        <th class="py-3 px-6 text-left">Nama Pelanggan</th>
                                        <th class="py-3 px-6 text-left">Voucher 2000 Terjual</th>
                                        <th class="py-3 px-6 text-left">Voucher 5000 Terjual</th>
                                        <th class="py-3 px-6 text-left">Total Tagihan</th>
                                    </tr>
                                </thead>
                                <tbody id="laporan-body" class="text-gray-600 text-sm font-light">
                                    <!-- Data akan diisi di sini -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 text-right">
                            <p class="text-lg font-semibold text-gray-800">Jumlah Pendapatan: <span id="total-pendapatan-laporan" class="text-red-600">Rp 0</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Logika aplikasi
        const elements = {
            loginSection: document.getElementById('login-section'),
            mainApp: document.getElementById('main-app'),
            loginBtn: document.getElementById('login-btn'),
            registerBtn: document.getElementById('register-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            usernameInput: document.getElementById('username-input'),
            passwordInput: document.getElementById('password-input'),
            welcomeMessage: document.getElementById('welcome-message'),
            
            navPelanggan: document.getElementById('nav-pelanggan'),
            navVoucher: document.getElementById('nav-voucher'),
            navPenagihan: document.getElementById('nav-penagihan'),
            navLaporan: document.getElementById('nav-laporan'),

            contentPelanggan: document.getElementById('content-pelanggan'),
            contentVoucher: document.getElementById('content-voucher'),
            contentPenagihan: document.getElementById('content-penagihan'),
            contentLaporan: document.getElementById('content-laporan'),

            btnTipeBulanan: document.getElementById('btn-tipe-bulanan'),
            btnTipeToko: document.getElementById('btn-tipe-toko'),
            formPelanggan: document.getElementById('form-pelanggan'),
            infoTagihanBulanan: document.getElementById('info-tagihan-bulanan'),
            infoTagihanToko: document.getElementById('info-tagihan-toko'),

            selectToko: document.getElementById('select-toko'),
            inputVocer2000: document.getElementById('input-vocer-2000'),
            inputVocer5000: document.getElementById('input-vocer-5000'),
            simpanVoucherBtn: document.getElementById('simpan-voucher'),
            riwayatVoucherBody: document.getElementById('riwayat-voucher-body'),

            btnTagihanBulanan: document.getElementById('btn-tagihan-bulanan'),
            btnTagihanToko: document.getElementById('btn-tagihan-toko'),
            penagihanBulananSection: document.getElementById('penagihan-bulanan-section'),
            penagihanTokoSection: document.getElementById('penagihan-toko-section'),
            selectPelangganBulanan: document.getElementById('select-pelanggan-bulanan'),
            totalTagihanBulanan: document.getElementById('total-tagihan-bulanan'),
            bayarBulananBtn: document.getElementById('bayar-bulanan'),
            selectPelangganToko: document.getElementById('select-pelanggan-toko'),
            tanggalMulai: document.getElementById('tanggal-mulai'),
            tanggalSelesai: document.getElementById('tanggal-selesai'),
            totalVoucherTerkirim: document.getElementById('total-voucher-terkirim'),
            sisaVoucher: document.getElementById('sisa-voucher'),
            totalTagihanToko: document.getElementById('total-tagihan-toko'),
            bayarTokoBtn: document.getElementById('bayar-toko'),

            laporanTanggalMulai: document.getElementById('laporan-tanggal-mulai'),
            laporanTanggalSelesai: document.getElementById('laporan-tanggal-selesai'),
            tampilkanLaporanBtn: document.getElementById('tampilkan-laporan'),
            laporanBody: document.getElementById('laporan-body'),
            totalPendapatanLaporan: document.getElementById('total-pendapatan-laporan'),
            exportPdfBtn: document.getElementById('export-pdf'),
            exportExcelBtn: document.getElementById('export-excel'),

            // Modal
            modalBackdrop: document.getElementById('modal-backdrop'),
            customModal: document.getElementById('custom-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            modalCancelBtn: document.getElementById('modal-cancel-btn')
        };

        const showModal = (title, message) => {
            return new Promise((resolve) => {
                elements.modalTitle.textContent = title;
                elements.modalMessage.textContent = message;
                elements.modalBackdrop.classList.remove('hidden');
                elements.customModal.classList.remove('hidden');

                const handleConfirm = () => {
                    elements.modalBackdrop.classList.add('hidden');
                    elements.customModal.classList.add('hidden');
                    resolve(true);
                };

                const handleCancel = () => {
                    elements.modalBackdrop.classList.add('hidden');
                    elements.customModal.classList.add('hidden');
                    resolve(false);
                };

                elements.modalConfirmBtn.onclick = handleConfirm;
                elements.modalCancelBtn.onclick = handleCancel;
            });
        };

        // Mengatur tampilan
        const hideAllContent = () => {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-gray-200', 'text-gray-800');
                btn.classList.add('bg-red-600', 'text-white');
            });
        };

        const setActiveNav = (btn) => {
            btn.classList.remove('bg-red-600', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-800');
        };

        const showSection = (sectionId) => {
            hideAllContent();
            document.getElementById(sectionId).classList.remove('hidden');
        };

        // Event Listeners Navigasi
        elements.navPelanggan.addEventListener('click', () => {
            showSection('content-pelanggan');
            setActiveNav(elements.navPelanggan);
        });
        elements.navVoucher.addEventListener('click', () => {
            showSection('content-voucher');
            setActiveNav(elements.navVoucher);
            loadTokoOptions();
            loadRiwayatVoucher();
        });
        elements.navPenagihan.addEventListener('click', () => {
            showSection('content-penagihan');
            setActiveNav(elements.navPenagihan);
            loadPelangganBulananOptions();
            loadPelangganTokoOptions();
        });
        elements.navLaporan.addEventListener('click', () => {
            showSection('content-laporan');
            setActiveNav(elements.navLaporan);
        });

        // Autentikasi
        let users = JSON.parse(localStorage.getItem('users')) || {};
        let loggedInUser = localStorage.getItem('loggedInUser');

        const saveUsers = () => {
            localStorage.setItem('users', JSON.stringify(users));
        };

        elements.loginBtn.addEventListener('click', () => {
            const username = elements.usernameInput.value;
            const password = elements.passwordInput.value;
            if (users[username] && users[username] === password) {
                localStorage.setItem('loggedInUser', username);
                checkAuth();
            } else {
                Swal.fire('Error', 'Username atau password salah!', 'error');
            }
        });

        elements.registerBtn.addEventListener('click', () => {
            const username = elements.usernameInput.value;
            const password = elements.passwordInput.value;
            if (username && password) {
                if (users[username]) {
                    Swal.fire('Error', 'Username sudah terdaftar!', 'error');
                } else {
                    users[username] = password;
                    saveUsers();
                    Swal.fire('Sukses', 'Registrasi berhasil! Silakan login.', 'success');
                    elements.usernameInput.value = '';
                    elements.passwordInput.value = '';
                }
            } else {
                Swal.fire('Error', 'Username dan password tidak boleh kosong!', 'error');
            }
        });

        elements.logoutBtn.addEventListener('click', async () => {
            const confirmed = await showModal('Logout', 'Apakah Anda yakin ingin logout?');
            if (confirmed) {
                localStorage.removeItem('loggedInUser');
                checkAuth();
            }
        });

        const checkAuth = () => {
            loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                elements.loginSection.classList.add('hidden');
                elements.mainApp.classList.remove('hidden');
                elements.welcomeMessage.textContent = `Selamat datang, ${loggedInUser}!`;
                showSection('content-pelanggan');
                setActiveNav(elements.navPelanggan);
            } else {
                elements.loginSection.classList.remove('hidden');
                elements.mainApp.classList.add('hidden');
            }
        };

        // Data Pelanggan
        let pelanggan = JSON.parse(localStorage.getItem('pelanggan')) || [];
        let jenisPelangganSaatIni = 'bulanan';

        const savePelanggan = () => {
            localStorage.setItem('pelanggan', JSON.stringify(pelanggan));
        };

        elements.btnTipeBulanan.addEventListener('click', () => {
            jenisPelangganSaatIni = 'bulanan';
            elements.infoTagihanBulanan.classList.remove('hidden');
            elements.infoTagihanToko.classList.add('hidden');
            elements.btnTipeBulanan.classList.add('bg-red-600', 'text-white');
            elements.btnTipeBulanan.classList.remove('bg-gray-300', 'text-gray-700');
            elements.btnTipeToko.classList.add('bg-gray-300', 'text-gray-700');
            elements.btnTipeToko.classList.remove('bg-red-600', 'text-white');
        });

        elements.btnTipeToko.addEventListener('click', () => {
            jenisPelangganSaatIni = 'toko';
            elements.infoTagihanBulanan.classList.add('hidden');
            elements.infoTagihanToko.classList.remove('hidden');
            elements.btnTipeToko.classList.add('bg-red-600', 'text-white');
            elements.btnTipeToko.classList.remove('bg-gray-300', 'text-gray-700');
            elements.btnTipeBulanan.classList.add('bg-gray-300', 'text-gray-700');
            elements.btnTipeBulanan.classList.remove('bg-red-600', 'text-white');
        });

        elements.formPelanggan.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nama = document.getElementById('nama-pelanggan').value;
            const alamat = document.getElementById('alamat-pelanggan').value;
            const hp = document.getElementById('hp-pelanggan').value;
            const lokasi = document.getElementById('lokasi-pelanggan').value;
            
            let tagihanInfo = {};
            if (jenisPelangganSaatIni === 'bulanan') {
                tagihanInfo.total = document.getElementById('tagihan-bulanan').value;
            } else {
                tagihanInfo.persen = document.getElementById('persentase-toko').value;
            }

            const newPelanggan = {
                id: Date.now(),
                jenis: jenisPelangganSaatIni,
                nama,
                alamat,
                hp,
                lokasi,
                ...tagihanInfo
            };

            pelanggan.push(newPelanggan);
            savePelanggan();
            Swal.fire('Sukses', 'Data pelanggan berhasil disimpan!', 'success');
            elements.formPelanggan.reset();
        });

        // Input Pengiriman Voucher
        let pengirimanVoucher = JSON.parse(localStorage.getItem('pengirimanVoucher')) || [];
        const savePengirimanVoucher = () => {
            localStorage.setItem('pengirimanVoucher', JSON.stringify(pengirimanVoucher));
        };

        const loadTokoOptions = () => {
            const tokoList = pelanggan.filter(p => p.jenis === 'toko');
            elements.selectToko.innerHTML = '<option value="">-- Pilih Toko --</option>';
            tokoList.forEach(toko => {
                const option = document.createElement('option');
                option.value = toko.id;
                option.textContent = toko.nama;
                elements.selectToko.appendChild(option);
            });
        };

        const loadRiwayatVoucher = () => {
            const tokoId = elements.selectToko.value;
            const riwayat = pengirimanVoucher.filter(p => p.idToko === tokoId);
            elements.riwayatVoucherBody.innerHTML = '';
            riwayat.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap">${index + 1}</td>
                    <td class="py-3 px-6 text-left">${item.tanggal}</td>
                    <td class="py-3 px-6 text-left">${item.namaToko}</td>
                    <td class="py-3 px-6 text-left">${item.vocer2000}</td>
                    <td class="py-3 px-6 text-left">${item.vocer5000}</td>
                    <td class="py-3 px-6 text-left">
                        <button class="bg-gray-200 text-gray-800 font-medium py-1 px-3 rounded-lg hover:bg-gray-300 transition edit-btn" data-id="${item.id}">Edit</button>
                        <button class="bg-red-600 text-white font-medium py-1 px-3 rounded-lg hover:bg-red-700 transition delete-btn" data-id="${item.id}">Hapus</button>
                    </td>
                `;
                elements.riwayatVoucherBody.appendChild(row);
            });

            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = parseInt(e.target.dataset.id);
                    const itemToEdit = pengirimanVoucher.find(p => p.id === id);
                    if (itemToEdit) {
                        const confirmed = await showModal(
                            'Edit Pengiriman',
                            `Apakah Anda ingin mengedit pengiriman ini?`
                        );
                        if (confirmed) {
                             const { value: formValues } = await Swal.fire({
                                title: 'Edit Pengiriman Voucher',
                                html:
                                    `<label for="swal-input1" class="text-sm font-medium text-gray-700">Voucher 2000</label>` +
                                    `<input id="swal-input1" class="swal2-input" value="${itemToEdit.vocer2000}">` +
                                    `<label for="swal-input2" class="text-sm font-medium text-gray-700">Voucher 5000</label>` +
                                    `<input id="swal-input2" class="swal2-input" value="${itemToEdit.vocer5000}">`,
                                focusConfirm: false,
                                preConfirm: () => {
                                    return [
                                        document.getElementById('swal-input1').value,
                                        document.getElementById('swal-input2').value
                                    ];
                                }
                            });
                            if (formValues) {
                                itemToEdit.vocer2000 = parseInt(formValues[0]);
                                itemToEdit.vocer5000 = parseInt(formValues[1]);
                                savePengirimanVoucher();
                                loadRiwayatVoucher();
                                Swal.fire('Sukses!', 'Data berhasil diubah.', 'success');
                            }
                        }
                    }
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = parseInt(e.target.dataset.id);
                    const confirmed = await showModal('Hapus Pengiriman', 'Apakah Anda yakin ingin menghapus pengiriman ini?');
                    if (confirmed) {
                        pengirimanVoucher = pengirimanVoucher.filter(p => p.id !== id);
                        savePengirimanVoucher();
                        loadRiwayatVoucher();
                        Swal.fire('Sukses!', 'Data berhasil dihapus.', 'success');
                    }
                });
            });
        };

        elements.selectToko.addEventListener('change', loadRiwayatVoucher);
        elements.simpanVoucherBtn.addEventListener('click', () => {
            const tokoId = elements.selectToko.value;
            const namaToko = elements.selectToko.options[elements.selectToko.selectedIndex].text;
            const vocer2000 = parseInt(elements.inputVocer2000.value) || 0;
            const vocer5000 = parseInt(elements.inputVocer5000.value) || 0;

            if (tokoId) {
                const newPengiriman = {
                    id: Date.now(),
                    tanggal: new Date().toISOString().slice(0, 10),
                    idToko: tokoId,
                    namaToko,
                    vocer2000,
                    vocer5000
                };
                pengirimanVoucher.push(newPengiriman);
                savePengirimanVoucher();
                Swal.fire('Sukses', 'Pengiriman voucher berhasil disimpan!', 'success');
                elements.inputVocer2000.value = '';
                elements.inputVocer5000.value = '';
                loadRiwayatVoucher();
            } else {
                Swal.fire('Error', 'Silakan pilih toko!', 'error');
            }
        });

        // Penagihan
        const loadPelangganBulananOptions = () => {
            const bulananList = pelanggan.filter(p => p.jenis === 'bulanan');
            elements.selectPelangganBulanan.innerHTML = '<option value="">-- Pilih Pelanggan --</option>';
            bulananList.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.nama;
                elements.selectPelangganBulanan.appendChild(option);
            });
        };

        const loadPelangganTokoOptions = () => {
            const tokoList = pelanggan.filter(p => p.jenis === 'toko');
            elements.selectPelangganToko.innerHTML = '<option value="">-- Pilih Toko --</option>';
            tokoList.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.nama;
                elements.selectPelangganToko.appendChild(option);
            });
        };

        elements.btnTagihanBulanan.addEventListener('click', () => {
            elements.penagihanBulananSection.classList.remove('hidden');
            elements.penagihanTokoSection.classList.add('hidden');
            elements.btnTagihanBulanan.classList.add('bg-red-600', 'text-white');
            elements.btnTagihanBulanan.classList.remove('bg-gray-300', 'text-gray-700');
            elements.btnTagihanToko.classList.add('bg-gray-300', 'text-gray-700');
            elements.btnTagihanToko.classList.remove('bg-red-600', 'text-white');
            loadPelangganBulananOptions();
        });

        elements.btnTagihanToko.addEventListener('click', () => {
            elements.penagihanTokoSection.classList.remove('hidden');
            elements.penagihanBulananSection.classList.add('hidden');
            elements.btnTagihanToko.classList.add('bg-red-600', 'text-white');
            elements.btnTagihanToko.classList.remove('bg-gray-300', 'text-gray-700');
            elements.btnTagihanBulanan.classList.add('bg-gray-300', 'text-gray-700');
            elements.btnTagihanBulanan.classList.remove('bg-red-600', 'text-white');
            loadPelangganTokoOptions();
        });

        elements.selectPelangganBulanan.addEventListener('change', (e) => {
            const pelangganId = e.target.value;
            const selectedPelanggan = pelanggan.find(p => p.id == pelangganId);
            if (selectedPelanggan) {
                elements.totalTagihanBulanan.value = selectedPelanggan.total || 0;
            }
        });

        elements.selectPelangganToko.addEventListener('change', () => {
            elements.tanggalMulai.value = '';
            elements.tanggalSelesai.value = '';
            elements.totalVoucherTerkirim.value = '';
            elements.sisaVoucher.value = '';
            elements.totalTagihanToko.value = '';
        });

        elements.tanggalSelesai.addEventListener('change', () => {
            const tokoId = elements.selectPelangganToko.value;
            const tMulai = new Date(elements.tanggalMulai.value);
            const tSelesai = new Date(elements.tanggalSelesai.value);

            if (tokoId && tMulai && tSelesai) {
                const voucherTerkirim = pengirimanVoucher.filter(p => {
                    const tglPengiriman = new Date(p.tanggal);
                    return p.idToko == tokoId && tglPengiriman >= tMulai && tglPengiriman <= tSelesai;
                });
                const totalVoucher = voucherTerkirim.reduce((acc, curr) => acc + curr.vocer2000 + curr.vocer5000, 0);
                elements.totalVoucherTerkirim.value = totalVoucher;
            }
        });

        elements.sisaVoucher.addEventListener('input', () => {
            const totalTerkirim = parseInt(elements.totalVoucherTerkirim.value) || 0;
            const sisa = parseInt(elements.sisaVoucher.value) || 0;
            const totalTerjual = totalTerkirim - sisa;

            const tokoId = elements.selectPelangganToko.value;
            const selectedToko = pelanggan.find(p => p.id == tokoId);
            if (selectedToko) {
                const persenToko = parseFloat(selectedToko.persen) / 100;
                const totalTagihan = totalTerjual * (1 - persenToko);
                elements.totalTagihanToko.value = totalTagihan;
            }
        });

        elements.bayarTokoBtn.addEventListener('click', async () => {
            const confirmed = await showModal('Konfirmasi Pembayaran', 'Apakah Anda yakin ingin menyelesaikan pembayaran?');
            if (confirmed) {
                const tokoId = elements.selectPelangganToko.value;
                const totalTagihan = elements.totalTagihanToko.value;
                const totalVoucherTerjual = (parseInt(elements.totalVoucherTerkirim.value) || 0) - (parseInt(elements.sisaVoucher.value) || 0);
                
                if (tokoId && totalTagihan) {
                    const tagihan = {
                        tanggal: new Date().toISOString().slice(0, 10),
                        idPelanggan: tokoId,
                        namaPelanggan: elements.selectPelangganToko.options[elements.selectPelangganToko.selectedIndex].text,
                        jenis: 'toko',
                        total: totalTagihan,
                        voucherTerjual: totalVoucherTerjual
                    };
                    let laporan = JSON.parse(localStorage.getItem('laporan')) || [];
                    laporan.push(tagihan);
                    localStorage.setItem('laporan', JSON.stringify(laporan));

                    // Hapus voucher yang sudah ditagih
                    const tMulai = new Date(elements.tanggalMulai.value);
                    const tSelesai = new Date(elements.tanggalSelesai.value);
                    pengirimanVoucher = pengirimanVoucher.filter(p => {
                        const tglPengiriman = new Date(p.tanggal);
                        return !(p.idToko == tokoId && tglPengiriman >= tMulai && tglPengiriman <= tSelesai);
                    });
                    savePengirimanVoucher();

                    Swal.fire('Sukses', 'Pembayaran berhasil!', 'success');
                    elements.selectPelangganToko.value = '';
                    elements.tanggalMulai.value = '';
                    elements.tanggalSelesai.value = '';
                    elements.totalVoucherTerkirim.value = '';
                    elements.sisaVoucher.value = '';
                    elements.totalTagihanToko.value = '';
                } else {
                    Swal.fire('Error', 'Data tidak lengkap!', 'error');
                }
            }
        });

        elements.bayarBulananBtn.addEventListener('click', () => {
            const pelangganId = elements.selectPelangganBulanan.value;
            const totalTagihan = elements.totalTagihanBulanan.value;
            
            if (pelangganId && totalTagihan) {
                const tagihan = {
                    tanggal: new Date().toISOString().slice(0, 10),
                    idPelanggan: pelangganId,
                    namaPelanggan: elements.selectPelangganBulanan.options[elements.selectPelangganBulanan.selectedIndex].text,
                    jenis: 'bulanan',
                    total: totalTagihan
                };
                let laporan = JSON.parse(localStorage.getItem('laporan')) || [];
                laporan.push(tagihan);
                localStorage.setItem('laporan', JSON.stringify(laporan));

                Swal.fire('Sukses', 'Pembayaran berhasil!', 'success');
                elements.selectPelangganBulanan.value = '';
                elements.totalTagihanBulanan.value = '';
            } else {
                Swal.fire('Error', 'Data tidak lengkap!', 'error');
            }
        });

        // Laporan
        elements.tampilkanLaporanBtn.addEventListener('click', () => {
            const tMulai = elements.laporanTanggalMulai.value;
            const tSelesai = elements.laporanTanggalSelesai.value;

            if (!tMulai || !tSelesai) {
                Swal.fire('Error', 'Silakan pilih rentang tanggal!', 'error');
                return;
            }

            const laporanData = JSON.parse(localStorage.getItem('laporan')) || [];
            const laporanFiltered = laporanData.filter(l => {
                const tglLaporan = new Date(l.tanggal);
                return tglLaporan >= new Date(tMulai) && tglLaporan <= new Date(tSelesai);
            });

            elements.laporanBody.innerHTML = '';
            let totalPendapatan = 0;
            laporanFiltered.forEach((l, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                
                let voucher2000 = 0;
                let voucher5000 = 0;
                if (l.jenis === 'toko') {
                    // Logika perhitungan voucher terjual dari total voucher
                    const totalVoucher = pengirimanVoucher.filter(p => p.idToko == l.idPelanggan).reduce((acc, curr) => acc + curr.vocer2000 + curr.vocer5000, 0);
                    const sisaVoucher = pelanggan.find(p => p.id == l.idPelanggan)?.sisaVoucher || 0;
                    const voucherTerjual = totalVoucher - sisaVoucher;
                    // Ini adalah contoh sederhana, Anda mungkin perlu menyimpan detail voucher2000/5000 di laporan
                    voucher2000 = voucherTerjual; 
                }

                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap">${index + 1}</td>
                    <td class="py-3 px-6 text-left">${l.namaPelanggan}</td>
                    <td class="py-3 px-6 text-left">${voucher2000}</td>
                    <td class="py-3 px-6 text-left">${voucher5000}</td>
                    <td class="py-3 px-6 text-left">Rp ${l.total.toLocaleString('id-ID')}</td>
                `;
                elements.laporanBody.appendChild(row);
                totalPendapatan += l.total;
            });

            elements.totalPendapatanLaporan.textContent = `Rp ${totalPendapatan.toLocaleString('id-ID')}`;
        });

        // Export PDF
        elements.exportPdfBtn.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const tMulai = elements.laporanTanggalMulai.value;
            const tSelesai = elements.laporanTanggalSelesai.value;

            doc.setFontSize(18);
            doc.text("Laporan Penjualan Indiego.Net", 14, 22);
            doc.setFontSize(12);
            doc.text(`Periode: ${tMulai} s/d ${tSelesai}`, 14, 30);
            
            const tableHeaders = ["No", "Nama Pelanggan", "Voucher 2000 Terjual", "Voucher 5000 Terjual", "Total Tagihan"];
            const tableData = [];
            const rows = document.querySelectorAll('#laporan-body tr');
            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                tableData.push([
                    cells[0].textContent,
                    cells[1].textContent,
                    cells[2].textContent,
                    cells[3].textContent,
                    cells[4].textContent
                ]);
            });

            doc.autoTable({
                startY: 40,
                head: [tableHeaders],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: '#E53935' },
                styles: { fontSize: 10 }
            });

            const finalY = doc.autoTable.previous.finalY;
            const totalPendapatanText = elements.totalPendapatanLaporan.textContent;
            doc.setFontSize(12);
            doc.text(`Jumlah Pendapatan: ${totalPendapatanText}`, 14, finalY + 10);

            doc.save(`Laporan_Penjualan_${tMulai}_sd_${tSelesai}.pdf`);
        });

        // Export Excel
        elements.exportExcelBtn.addEventListener('click', () => {
            const tMulai = elements.laporanTanggalMulai.value;
            const tSelesai = elements.laporanTanggalSelesai.value;

            const table = document.getElementById('tabel-laporan');
            const ws = XLSX.utils.table_to_sheet(table);
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, ws, "Laporan Penjualan");

            // Tambahkan judul dan rentang tanggal
            const range = XLSX.utils.decode_range(ws['!ref']);
            const newRange = { s: { r: range.s.r + 2, c: 0 }, e: range.e };
            
            // Tambahkan baris di atas tabel
            XLSX.utils.sheet_add_aoa(ws, [["Laporan Penjualan Indiego.Net"], [`Periode: ${tMulai} s/d ${tSelesai}`]], { origin: "A1" });
            
            // Tambahkan total pendapatan
            const totalRow = [['', '', '', 'Jumlah Pendapatan:', elements.totalPendapatanLaporan.textContent.replace('Rp ', '')]];
            XLSX.utils.sheet_add_aoa(ws, totalRow, { origin: -1 });

            // Sesuaikan lebar kolom
            ws['!cols'] = [
                { wch: 5 }, // No
                { wch: 25 }, // Nama
                { wch: 15 }, // 2000
                { wch: 15 }, // 5000
                { wch: 15 }  // Total
            ];

            XLSX.writeFile(workbook, `Laporan_Penjualan_${tMulai}_sd_${tSelesai}.xlsx`);
        });
        
        // Pendaftaran service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker berhasil didaftarkan:', registration);
                    })
                    .catch(err => {
                        console.log('Pendaftaran Service Worker gagal:', err);
                    });
            });
        }
        
        checkAuth();

    </script>
</body>
</html>

